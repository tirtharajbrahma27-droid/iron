<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STARK LABS | DIAGNOSTIC MODE</title>
    <style>
        /* CORE STYLING */
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; user-select: none; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        /* UI OVERLAYS */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; padding: 30px; box-sizing: border-box; }
        .hud-panel { position: absolute; border: 1px solid rgba(0, 255, 255, 0.3); background: rgba(0, 20, 40, 0.4); padding: 15px; }
        .hud-text { color: #00ffff; text-shadow: 0 0 5px #00ffff; letter-spacing: 2px; text-transform: uppercase; font-weight: bold; }
        
        #top-left { top: 30px; left: 30px; border-left: 4px solid #00ffff; }
        
        /* START SCREEN - VISIBLE BY DEFAULT */
        #overlay-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 100; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            pointer-events: auto;
        }
        
        #start-btn {
            background: #000; border: 2px solid #00ffff; color: #00ffff;
            padding: 20px 50px; font-size: 20px; letter-spacing: 3px; cursor: pointer;
            box-shadow: 0 0 15px #00ffff; font-family: inherit; font-weight: bold;
            transition: 0.3s;
        }
        #start-btn:hover { background: #00ffff; color: #000; }
        
        /* ERROR MESSAGE STYLING */
        #status-log { 
            margin-top: 30px; color: #ff3333; font-size: 14px; 
            text-align: center; max-width: 600px; line-height: 1.6; 
            border: 1px dashed #ff3333; padding: 20px; display: none;
        }
        
        .success-log { border-color: #00ff00 !important; color: #00ff00 !important; }

        #input-video { display: none; }
    </style>
    
    <!-- LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <!-- POST PROCESS -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
</head>
<body>

    <!-- OVERLAY -->
    <div id="overlay-screen">
        <h1 class="hud-text" style="font-size: 40px; margin-bottom: 20px;">STARK OS</h1>
        <button id="start-btn">INITIALIZE SYSTEM</button>
        <div id="status-log">Checking System Integrity...</div>
    </div>

    <!-- HUD -->
    <div id="ui-layer">
        <div id="top-left" class="hud-panel">
            <div class="hud-text">Mk. 85 PROTOCOL</div>
            <div style="color: #00ffff; font-size: 12px; margin-top: 5px;">STATUS: <span id="sys-status">STANDBY</span></div>
        </div>
    </div>

    <!-- CANVAS -->
    <div id="canvas-container"></div>
    <video id="input-video" playsinline></video>

<script>
    // --- DIAGNOSTIC TOOLS ---
    const logBox = document.getElementById('status-log');
    const startBtn = document.getElementById('start-btn');
    
    function showError(msg) {
        logBox.style.display = 'block';
        logBox.innerHTML = "âš  ERROR DETECTED:<br>" + msg;
        startBtn.innerText = "SYSTEM FAILURE";
        startBtn.style.borderColor = "#ff3333";
        startBtn.style.color = "#ff3333";
        startBtn.style.pointerEvents = "none";
    }

    // --- STEP 1: CHECK PROTOCOL (FILE vs SERVER) ---
    if (window.location.protocol === 'file:') {
        showError("<b>YOU ARE RUNNING ON FILE:// PROTOCOL</b><br><br>Browsers strictly BLOCK camera access on local files.<br>The code works, but your browser is stopping it.<br><br><b>SOLUTION:</b><br>1. Use VS Code 'Live Server' extension.<br>2. Or upload this file to GitHub Pages/CodePen.");
        throw new Error("Protocol Blocked");
    }

    // --- STEP 2: CHECK LIBRARIES ---
    window.onload = function() {
        if (typeof THREE === 'undefined' || typeof Hands === 'undefined') {
            showError("<b>INTERNET CONNECTION ERROR</b><br><br>The AI libraries failed to download.<br>Check your internet connection or Firewall.");
            return;
        }

        // Check if WebGL is enabled
        try {
            const canvas = document.createElement( 'canvas' ); 
            if( !window.WebGLRenderingContext || !canvas.getContext( 'webgl' ) ) {
                showError("<b>WEBGL NOT SUPPORTED</b><br>Your browser does not support 3D rendering.");
                return;
            }
        } catch (e) { showError(e.message); return; }
        
        // Everything OK
        logBox.style.display = 'block';
        logBox.className = "success-log";
        logBox.innerHTML = "SYSTEM INTEGRITY: 100%<br>READY TO INITIALIZE.";
    };

    // --- STEP 3: INITIALIZATION ---
    startBtn.addEventListener('click', async () => {
        startBtn.innerText = "ACCESSING OPTICAL SENSORS...";
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
            document.getElementById('input-video').srcObject = stream;
            document.getElementById('input-video').play();
            
            // Hide Overlay
            document.getElementById('overlay-screen').style.opacity = 0;
            setTimeout(() => document.getElementById('overlay-screen').style.display = 'none', 1000);
            
            initIronMan(); // Start the heavy code
            
        } catch (err) {
            console.error(err);
            showError("<b>CAMERA ACCESS DENIED</b><br><br>Browser Error: " + err.message + "<br><br>Check the lock icon in your address bar.");
        }
    });

    // --- MAIN LOGIC (Wrapped in function to prevent crash) ---
    function initIronMan() {
        document.getElementById('sys-status').innerText = "ONLINE";
        document.getElementById('sys-status').style.color = "#00ff00";

        // CONFIG
        const CONFIG = { color: 0x00ffff, bg: 0x000510 };
        
        // SCENE
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(CONFIG.bg, 0.02);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 8;
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        container.appendChild(renderer.domElement);
        
        // HOLOGRAM
        const geometry = new THREE.IcosahedronGeometry(2, 2);
        const material = new THREE.MeshBasicMaterial({ color: CONFIG.color, wireframe: true, transparent:true, opacity:0.5 });
        const core = new THREE.Mesh(geometry, material);
        scene.add(core);

        // POST PROCESS (BLOOM)
        const composer = new THREE.EffectComposer(renderer);
        composer.addPass(new THREE.RenderPass(scene, camera));
        const bloom = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        composer.addPass(bloom);

        // AI LOGIC
        const videoElement = document.getElementById('input-video');
        let targetRotX = 0, targetRotY = 0;

        function onResults(results) {
            if(results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                // Simple calculation to avoid complexity crashes
                targetRotY = (lm[9].x - 0.5) * 5;
                targetRotX = (lm[9].y - 0.5) * 5;
            }
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6});
        hands.onResults(onResults);

        const cam = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });
        cam.start();

        // ANIMATION LOOP
        function animate() {
            requestAnimationFrame(animate);
            core.rotation.x += (targetRotX - core.rotation.x) * 0.1;
            core.rotation.y += (targetRotY - core.rotation.y) * 0.1;
            core.rotation.z += 0.005;
            composer.render();
        }
        animate();
        
        // Resize Handler
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
    }

</script>
</body>
</html>
